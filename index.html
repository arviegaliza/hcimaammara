<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quick Pick Hub - Order Tracking</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        /* --- CSS STYLES --- */
        :root {
            --primary: #FF5722;
            --secondary: #2C3E50;
            --light: #f4f4f4;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background-color: var(--light); color: #333; padding-bottom: 50px;}
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .hidden { display: none !important; }
        
        /* Navigation */
        nav { background: var(--secondary); color: white; padding: 15px 0; position: sticky; top: 0; z-index: 1000; }
        .nav-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .nav-links button { background: none; border: none; color: white; margin-left: 15px; cursor: pointer; font-size: 1rem; }
        .nav-links button:hover { text-decoration: underline; }
        .cart-badge { background: var(--primary); padding: 2px 6px; border-radius: 50%; font-size: 0.8rem; }

        /* Auth */
        .auth-container { max-width: 400px; margin: 50px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .btn { display: block; width: 100%; padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
        .btn:hover { background: #e64a19; }
        .btn-secondary { background: var(--secondary); margin-top: 10px; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        .btn-info { background: var(--info); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* Shop Grid */
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; margin-top: 20px; }
        .product-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; display: flex; flex-direction: column; }
        .product-card:hover { transform: translateY(-5px); }
        .product-img { width: 100%; height: 180px; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background-color: #eee; }
        .price { color: var(--primary); font-weight: bold; font-size: 1.1rem; margin-top: auto; padding-top: 10px;}
        .prod-id { font-size: 0.7rem; color: #999; margin-bottom: 5px; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; vertical-align: middle; }
        th { background: var(--secondary); color: white; }
        .table-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; display: block;}
        
        .status-pending { color: var(--warning); font-weight: bold; }
        .status-processing { color: blue; font-weight: bold; }
        .status-shipped { color: purple; font-weight: bold; }
        .status-delivered { color: var(--success); font-weight: bold; }

        /* Map Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 800px; position: relative; }
        #map { height: 400px; width: 100%; border-radius: 4px; margin-top: 15px; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; color: #666; }

        /* Checkout & Admin */
        .checkout-methods { display: flex; gap: 10px; margin: 15px 0; }
        .method-card { border: 1px solid #ddd; padding: 15px; flex: 1; cursor: pointer; text-align: center; border-radius: 4px; background: white; }
        .method-card.selected { border: 2px solid var(--primary); background: #fff3e0; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-number { font-size: 2rem; color: var(--primary); font-weight: bold; }

        /* Toast */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 3000; left: 50%; bottom: 30px; transform: translateX(-50%); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <nav>
        <div class="nav-content">
            <div class="logo">Quick Pick Hub</div>
            <div class="nav-links" id="nav-links"></div>
        </div>
    </nav>

    <div id="toast">Notification</div>

    <div id="map-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal" onclick="closeMap()">&times;</span>
            <h3>Order Tracking</h3>
            <p id="map-status-text">Locating courier...</p>
            <div id="map"></div>
        </div>
    </div>

    <div class="container">

        <div id="auth-section">
            <div class="auth-container">
                <h2 id="auth-title">Login</h2>
                <form id="auth-form">
                    <div class="form-group"><label>Username</label><input type="text" id="username" required placeholder="admin or user"></div>
                    <div class="form-group"><label>Password</label><input type="password" id="password" required placeholder="123"></div>
                    <button type="submit" class="btn">Login</button>
                    <button type="button" class="btn btn-secondary" id="toggle-auth">Switch to Register</button>
                </form>
                <p style="margin-top:10px; font-size:0.8rem; color:#666;">Try Admin: <b>admin / 123</b><br>Try User: <b>user / 123</b></p>
            </div>
        </div>

        <div id="shop-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Shop Furniture</h2>
                <small style="color:#666" id="product-count-display">0 Products found</small>
            </div>
            <div class="form-group" style="max-width: 400px; margin-top: 10px;">
                <input type="text" id="search-bar" placeholder="Search 100+ items (e.g., 'Sofa', 'Blue', 'Modern')..." onkeyup="renderShop()">
            </div>
            <div class="product-grid" id="product-list"></div>
        </div>

        <div id="cart-section" class="hidden">
            <h2>Your Shopping Cart</h2>
            <div id="cart-items"></div>
            <div id="cart-summary" style="text-align: right; margin-top: 20px;" class="hidden">
                <h3>Total: <span id="cart-total">₱0.00</span></h3>
                <button class="btn" style="width: 200px; margin-left: auto; margin-top: 10px;" onclick="goToCheckout()">Proceed to Checkout</button>
            </div>
        </div>

        <div id="checkout-section" class="hidden">
            <h2>Checkout</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <h3>Shipping Information</h3>
                    <form id="checkout-form">
                        <div class="form-group"><label>Full Name</label><input type="text" id="ship-name" required></div>
                        <div class="form-group"><label>Address</label><input type="text" id="ship-address" required placeholder="Street, Barangay, City"></div>
                        <div class="form-group"><label>City</label><input type="text" id="ship-city" required></div>
                        <div class="form-group"><label>Phone Number</label><input type="text" id="ship-phone" required></div>
                    </form>
                </div>
                <div>
                    <h3>Payment Method</h3>
                    <div class="checkout-methods">
                        <div class="method-card" onclick="selectPayment('GCash')" id="pm-gcash"><b>GCash</b></div>
                        <div class="method-card" onclick="selectPayment('COD')" id="pm-cod"><b>COD</b></div>
                        <div class="method-card" onclick="selectPayment('Bank')" id="pm-bank"><b>Bank Transfer</b></div>
                    </div>
                    <div id="payment-details" style="margin-top: 15px; padding: 10px; background: white; border: 1px solid #ddd; display: none;"></div>
                    <button class="btn" style="margin-top: 20px;" onclick="placeOrder()">Place Order</button>
                    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="showSection('cart'); renderCart()">Back to Cart</button>
                </div>
            </div>
        </div>

        <div id="tracking-section" class="hidden">
            <h2>My Orders</h2>
            <table id="customer-orders-table">
                <thead><tr><th>Order ID</th><th>Date</th><th>Total</th><th>Status</th><th>Track</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="admin-dashboard-section" class="hidden">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap: wrap; gap:10px;">
                <h2>Admin Dashboard</h2>
                <button onclick="resetDataAndGenerate100()" class="btn-danger" style="width: auto;">Reset Data (Generate 100 Products)</button>
            </div>
            
            <div class="stats-grid" style="margin-top:20px;">
                <div class="stat-card"><h3>Total Sales</h3><div class="stat-number" id="adm-sales">₱0</div></div>
                <div class="stat-card"><h3>Total Orders</h3><div class="stat-number" id="adm-orders">0</div></div>
                <div class="stat-card"><h3>Products</h3><div class="stat-number" id="adm-products">0</div></div>
            </div>

            <h3 style="margin-top: 30px;">Manage Orders</h3>
            <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
                <table id="admin-orders-table">
                    <thead><tr><th>ID</th><th>Customer</th><th>Method</th><th>Total</th><th>Status</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>

            <h3 style="margin-top: 30px;">Manage Inventory</h3>
            <div class="form-group" style="display: flex; gap: 10px; background: white; padding: 10px; flex-wrap: wrap; align-items:flex-end;">
                <input type="text" id="new-prod-name" placeholder="Name" style="flex:2">
                <input type="number" id="new-prod-price" placeholder="Price" style="flex:1">
                <input type="text" id="new-prod-cat" placeholder="Category" style="flex:1">
                <input type="text" id="new-prod-img" placeholder="Image URL" style="flex:2">
                <button class="btn" style="width: auto;" onclick="addProduct()">Add</button>
            </div>
            <div style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                <table id="admin-products-table">
                    <thead><tr><th style="width:80px;">Image</th><th>Name</th><th>Price</th><th>Category</th><th>Action</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        /* --- JAVASCRIPT LOGIC --- */
        
        let currentUser = JSON.parse(localStorage.getItem('qp_currentUser')) || null;
        let selectedPayment = null;
        let map = null; // Map instance

        // --- 1. DATA INITIALIZATION ---
        function initData() {
            if (!localStorage.getItem('qp_users')) {
                const users = [{ username: 'admin', password: '123', role: 'admin' }, { username: 'user', password: '123', role: 'customer' }];
                localStorage.setItem('qp_users', JSON.stringify(users));
            }
            if (!localStorage.getItem('qp_products')) generateProducts(12);
            if (!localStorage.getItem('qp_orders')) localStorage.setItem('qp_orders', JSON.stringify([]));
            if (!sessionStorage.getItem('qp_cart')) sessionStorage.setItem('qp_cart', JSON.stringify([]));
        }

        function generateProducts(count) {
            const adjectives = ["Modern", "Vintage", "Minimalist", "Luxury", "Industrial", "Rustic", "Sleek", "Cozy", "Elegant", "Urban", "Classic", "Nordic", "Antique", "Premium", "Chic"];
            const materials = ["Leather", "Velvet", "Oak Wood", "Metal", "Glass", "Fabric", "Mahogany", "Pine", "Marble"];
            const types = [
                { name: "Sofa", cat: "Living Room", img: "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?fit=crop&w=300&q=80" },
                { name: "Armchair", cat: "Living Room", img: "https://images.unsplash.com/photo-1586023492125-27b2c045efd7?fit=crop&w=300&q=80" },
                { name: "Coffee Table", cat: "Living Room", img: "https://images.unsplash.com/photo-1533090481720-856c6e3c1fdc?fit=crop&w=300&q=80" },
                { name: "Dining Table", cat: "Dining", img: "https://images.unsplash.com/photo-1617806118233-18e1de247200?fit=crop&w=300&q=80" },
                { name: "Office Chair", cat: "Office", img: "https://images.unsplash.com/photo-1505843490538-5133c6c7d0e1?fit=crop&w=300&q=80" },
                { name: "Office Desk", cat: "Office", img: "https://images.unsplash.com/photo-1518455027359-f3f8164ba6bd?fit=crop&w=300&q=80" },
                { name: "King Bed", cat: "Bedroom", img: "https://images.unsplash.com/photo-1505693416388-b0346efee535?fit=crop&w=300&q=80" },
                { name: "Bedside Lamp", cat: "Bedroom", img: "https://images.unsplash.com/photo-1513506003011-3b644ab2a80d?fit=crop&w=300&q=80" },
                { name: "Wall Art", cat: "Decor", img: "https://images.unsplash.com/photo-1580130601254-05fa235e1e13?fit=crop&w=300&q=80" },
                { name: "Area Rug", cat: "Decor", img: "https://images.unsplash.com/photo-1575414003591-ece8d0416c7a?fit=crop&w=300&q=80" }
            ];

            let products = [];
            for (let i = 0; i < count; i++) {
                const randomAdj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const randomMat = materials[Math.floor(Math.random() * materials.length)];
                const randomType = types[Math.floor(Math.random() * types.length)];
                const price = Math.floor((Math.random() * 49000 + 1000) / 100) * 100;

                products.push({
                    id: Date.now() + i,
                    name: `${randomAdj} ${randomMat} ${randomType.name}`,
                    category: randomType.cat,
                    price: price,
                    image: randomType.img
                });
            }
            localStorage.setItem('qp_products', JSON.stringify(products));
        }

        function resetDataAndGenerate100() {
            if(confirm("Generate 100 new products? This replaces current inventory.")) {
                generateProducts(100);
                location.reload();
            }
        }
        initData();

        // --- 2. NAVIGATION ---
        const sections = {
            auth: document.getElementById('auth-section'),
            shop: document.getElementById('shop-section'),
            cart: document.getElementById('cart-section'),
            checkout: document.getElementById('checkout-section'),
            tracking: document.getElementById('tracking-section'),
            admin: document.getElementById('admin-dashboard-section')
        };

        function showSection(sectionName) {
            Object.values(sections).forEach(sec => sec.classList.add('hidden'));
            sections[sectionName].classList.remove('hidden');
            renderNav();
        }

        function renderNav() {
            const nav = document.getElementById('nav-links');
            nav.innerHTML = '';
            if (!currentUser) {
                nav.innerHTML = `<button onclick="showSection('auth')">Login / Register</button>`;
            } else if (currentUser.role === 'admin') {
                nav.innerHTML = `<button onclick="showSection('admin'); renderAdminDashboard()">Dashboard</button><button onclick="logout()">Logout</button>`;
            } else {
                const cart = JSON.parse(sessionStorage.getItem('qp_cart') || '[]');
                nav.innerHTML = `
                    <button onclick="showSection('shop'); renderShop()">Shop</button>
                    <button onclick="showSection('cart'); renderCart()">Cart <span class="cart-badge">${cart.length}</span></button>
                    <button onclick="showSection('tracking'); renderTracking()">My Orders</button>
                    <button onclick="logout()">Logout</button>
                `;
            }
        }

        // --- 3. AUTH ---
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        let isLogin = true;

        document.getElementById('toggle-auth').addEventListener('click', () => {
            isLogin = !isLogin;
            authTitle.innerText = isLogin ? 'Login' : 'Register';
            document.getElementById('toggle-auth').innerText = isLogin ? 'Switch to Register' : 'Switch to Login';
        });

        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            const users = JSON.parse(localStorage.getItem('qp_users'));

            if (isLogin) {
                const user = users.find(x => x.username === u && x.password === p);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('qp_currentUser', JSON.stringify(user));
                    showToast(`Welcome back, ${u}!`);
                    if (user.role === 'admin') { showSection('admin'); renderAdminDashboard(); }
                    else { showSection('shop'); renderShop(); }
                } else { showToast("Invalid Credentials"); }
            } else {
                if (users.find(x => x.username === u)) { showToast("Username taken"); return; }
                const newUser = { username: u, password: p, role: 'customer' };
                users.push(newUser);
                localStorage.setItem('qp_users', JSON.stringify(users));
                showToast("Registered successfully!");
                isLogin = true;
                authTitle.innerText = 'Login';
            }
        });

        function logout() {
            currentUser = null;
            localStorage.removeItem('qp_currentUser');
            sessionStorage.removeItem('qp_cart');
            showSection('auth');
            showToast("Logged out");
        }

        // --- 4. SHOP & CART ---
        function renderShop() {
            const list = document.getElementById('product-list');
            const term = document.getElementById('search-bar').value.toLowerCase();
            const products = JSON.parse(localStorage.getItem('qp_products'));
            const filtered = products.filter(p => p.name.toLowerCase().includes(term) || p.category.toLowerCase().includes(term));
            
            document.getElementById('product-count-display').innerText = `${filtered.length} Products found`;
            list.innerHTML = '';
            const limit = term === '' ? 50 : filtered.length;
            
            filtered.slice(0, limit).forEach(p => {
                list.innerHTML += `
                    <div class="product-card">
                        <img src="${p.image}" class="product-img" loading="lazy">
                        <div class="prod-id">#${p.id}</div>
                        <h3>${p.name}</h3>
                        <p style="color:#666; font-size:0.9rem">${p.category}</p>
                        <div class="price">₱${p.price.toLocaleString()}</div>
                        <button class="btn" style="margin-top:10px" onclick="addToCart(${p.id})">Add to Cart</button>
                    </div>
                `;
            });
            if(term === '' && products.length > 50) {
                 list.innerHTML += `<div style="grid-column: 1/-1; text-align:center; padding:20px; color:#666;">Use search to find specific items... (Showing top 50 of ${products.length})</div>`;
            }
        }

        function addToCart(id) {
            const products = JSON.parse(localStorage.getItem('qp_products'));
            const product = products.find(p => p.id === id);
            let cart = JSON.parse(sessionStorage.getItem('qp_cart') || '[]');
            cart.push(product);
            sessionStorage.setItem('qp_cart', JSON.stringify(cart));
            renderNav(); showToast("Item added");
        }

        function renderCart() {
            const container = document.getElementById('cart-items');
            const summary = document.getElementById('cart-summary');
            const cart = JSON.parse(sessionStorage.getItem('qp_cart') || '[]');
            let total = 0;
            if (cart.length === 0) {
                container.innerHTML = "<p>Cart is empty.</p>";
                summary.classList.add('hidden');
                return;
            }
            let html = `<table><thead><tr><th>Img</th><th>Name</th><th>Price</th><th>Action</th></tr></thead><tbody>`;
            cart.forEach((item, index) => {
                total += item.price;
                html += `<tr>
                    <td><img src="${item.image}" class="table-thumb"></td>
                    <td>${item.name}</td>
                    <td>₱${item.price.toLocaleString()}</td>
                    <td><button class="btn-danger" onclick="removeFromCart(${index})">X</button></td>
                </tr>`;
            });
            html += `</tbody></table>`;
            container.innerHTML = html;
            summary.classList.remove('hidden');
            document.getElementById('cart-total').innerText = "₱" + total.toLocaleString();
        }

        function removeFromCart(index) {
            let cart = JSON.parse(sessionStorage.getItem('qp_cart'));
            cart.splice(index, 1);
            sessionStorage.setItem('qp_cart', JSON.stringify(cart));
            renderCart(); renderNav();
        }

        function goToCheckout() {
            if (JSON.parse(sessionStorage.getItem('qp_cart') || '[]').length === 0) { showToast("Cart is empty"); return; }
            showSection('checkout');
        }

        // --- 5. CHECKOUT ---
        function selectPayment(method) {
            selectedPayment = method;
            document.querySelectorAll('.method-card').forEach(c => c.classList.remove('selected'));
            if(method === 'GCash') document.getElementById('pm-gcash').classList.add('selected');
            if(method === 'COD') document.getElementById('pm-cod').classList.add('selected');
            if(method === 'Bank') document.getElementById('pm-bank').classList.add('selected');
            document.getElementById('payment-details').style.display = 'block';
            document.getElementById('payment-details').innerHTML = method === 'GCash' ? 'GCash: 0917-XXX-XXXX' : method === 'Bank' ? 'BDO: 123-456-7890' : 'Pay Cash on Delivery';
        }

        function placeOrder() {
            const name = document.getElementById('ship-name').value;
            const address = document.getElementById('ship-address').value;
            if (!name || !address || !selectedPayment) { showToast("Complete details required"); return; }

            const cart = JSON.parse(sessionStorage.getItem('qp_cart'));
            const total = cart.reduce((sum, item) => sum + item.price, 0);
            
            const newOrder = {
                id: 'ORD-' + Math.floor(Math.random() * 10000),
                customer: currentUser.username,
                date: new Date().toLocaleDateString(),
                items: cart,
                total: total,
                status: 'Pending',
                method: selectedPayment,
                shipping: { name, address }
            };

            const orders = JSON.parse(localStorage.getItem('qp_orders') || '[]');
            orders.push(newOrder);
            localStorage.setItem('qp_orders', JSON.stringify(orders));
            sessionStorage.setItem('qp_cart', JSON.stringify([])); 
            showToast("Order Placed!");
            showSection('tracking');
            renderTracking();
        }

        // --- 6. TRACKING & MAP ---
        function renderTracking() {
            const tbody = document.querySelector('#customer-orders-table tbody');
            const orders = JSON.parse(localStorage.getItem('qp_orders') || '[]');
            const myOrders = orders.filter(o => o.customer === currentUser.username);
            tbody.innerHTML = '';
            myOrders.forEach(o => {
                tbody.innerHTML += `<tr>
                    <td>${o.id}</td>
                    <td>${o.date}</td>
                    <td>₱${o.total.toLocaleString()}</td>
                    <td class="status-${o.status.toLowerCase()}">${o.status}</td>
                    <td><button class="btn-info" onclick="openMap('${o.id}', '${o.status}')">Track Map</button></td>
                </tr>`;
            });
        }

        // MAP LOGIC
        function openMap(orderId, status) {
            document.getElementById('map-modal').classList.remove('hidden');
            document.getElementById('map-status-text').innerText = `Tracking Order ${orderId}: ${status}`;
            
            // Wait for modal to render before init map
            setTimeout(() => {
                if(map) { map.remove(); } // Reset map if exists
                
                // Fixed Warehouse Location (Manila)
                const start = [14.5995, 120.9842]; 
                
                // Simulate Customer Location (Random offset around Manila)
                const end = [
                    14.5995 + (Math.random() * 0.05 - 0.025), 
                    120.9842 + (Math.random() * 0.05 - 0.025)
                ];

                // Simulate Courier Location (Midpoint)
                const courier = [
                    (start[0] + end[0]) / 2,
                    (start[1] + end[1]) / 2
                ];

                map = L.map('map').setView(courier, 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; OpenStreetMap contributors'
                }).addTo(map);

                // Icons
                const createIcon = (color) => {
                    return new L.Icon({
                        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${color}.png`,
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
                    });
                };

                // Add Markers
                L.marker(start, {icon: createIcon('red')}).addTo(map).bindPopup("<b>Warehouse</b><br>Order Dispatched").openPopup();
                L.marker(end, {icon: createIcon('green')}).addTo(map).bindPopup("<b>Your Address</b><br>Destination");
                
                if (status !== 'Delivered') {
                    L.marker(courier, {icon: createIcon('blue')}).addTo(map).bindPopup("<b>Courier Truck</b><br>On the way!");
                    
                    // Draw Line
                    L.polyline([start, courier, end], {color: 'blue', weight: 4, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
                } else {
                    L.polyline([start, end], {color: 'green', weight: 4}).addTo(map);
                    document.getElementById('map-status-text').innerText += " (Arrived)";
                }

                // Fit bounds
                map.fitBounds([start, end], {padding: [50, 50]});

            }, 300);
        }

        function closeMap() {
            document.getElementById('map-modal').classList.add('hidden');
        }

        // --- 7. ADMIN ---
        function renderAdminDashboard() {
            const orders = JSON.parse(localStorage.getItem('qp_orders') || '[]');
            const products = JSON.parse(localStorage.getItem('qp_products'));
            
            const totalSales = orders.reduce((sum, o) => sum + o.total, 0);
            document.getElementById('adm-sales').innerText = "₱" + totalSales.toLocaleString();
            document.getElementById('adm-orders').innerText = orders.length;
            document.getElementById('adm-products').innerText = products.length;

            const orderTable = document.querySelector('#admin-orders-table tbody');
            orderTable.innerHTML = '';
            orders.forEach((o, index) => {
                orderTable.innerHTML += `<tr>
                    <td>${o.id}</td><td>${o.customer}</td><td>${o.method}</td><td>₱${o.total.toLocaleString()}</td>
                    <td><select onchange="updateStatus(${index}, this.value)"><option ${o.status==='Pending'?'selected':''}>Pending</option><option ${o.status==='Shipped'?'selected':''}>Shipped</option><option ${o.status==='Delivered'?'selected':''}>Delivered</option></select></td>
                    <td><button onclick="deleteOrder(${index})" class="btn-danger">Del</button></td>
                </tr>`;
            });

            const prodTable = document.querySelector('#admin-products-table tbody');
            prodTable.innerHTML = '';
            products.forEach((p, index) => {
                prodTable.innerHTML += `<tr>
                    <td><img src="${p.image}" class="table-thumb"></td>
                    <td style="font-size:0.9rem">${p.name}</td><td>₱${p.price.toLocaleString()}</td><td>${p.category}</td>
                    <td><button onclick="deleteProduct(${index})" class="btn-danger">X</button></td>
                </tr>`;
            });
        }

        function updateStatus(i, s) {
            const orders = JSON.parse(localStorage.getItem('qp_orders'));
            orders[i].status = s;
            localStorage.setItem('qp_orders', JSON.stringify(orders));
            showToast("Status Updated");
        }

        function deleteOrder(i) {
            const orders = JSON.parse(localStorage.getItem('qp_orders'));
            orders.splice(i, 1);
            localStorage.setItem('qp_orders', JSON.stringify(orders));
            renderAdminDashboard();
        }

        function addProduct() {
            const n = document.getElementById('new-prod-name').value;
            const p = document.getElementById('new-prod-price').value;
            const c = document.getElementById('new-prod-cat').value;
            const i = document.getElementById('new-prod-img').value || "https://images.unsplash.com/photo-1555041469-a586c61ea9bc?w=300";
            if(!n || !p) return showToast("Name/Price needed");
            
            const products = JSON.parse(localStorage.getItem('qp_products'));
            products.push({ id: Date.now(), name: n, price: parseFloat(p), category: c, image: i });
            localStorage.setItem('qp_products', JSON.stringify(products));
            renderAdminDashboard(); showToast("Added");
        }

        function deleteProduct(i) {
            if(!confirm("Delete?")) return;
            const products = JSON.parse(localStorage.getItem('qp_products'));
            products.splice(i, 1);
            localStorage.setItem('qp_products', JSON.stringify(products));
            renderAdminDashboard();
        }

        function showToast(msg) {
            const x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(() => x.className = x.className.replace("show", ""), 3000);
        }

        if (currentUser) {
            if(currentUser.role === 'admin') { showSection('admin'); renderAdminDashboard(); }
            else { showSection('shop'); renderShop(); }
        } else { showSection('auth'); }
    </script>
</body>
</html>